<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnnotateShot: Effortless Screenshot Markup</title>
    <meta name="description" content="AnnotateShot - ìŠ¤í¬ë¦°ìƒ·ì— ì‰½ê²Œ ìˆ«ìì™€ ë„í˜•ì„ ì¶”ê°€í•˜ì„¸ìš”. ê°„í¸í•˜ê³  íš¨ê³¼ì ì¸ ì´ë¯¸ì§€ ì£¼ì„ ë„êµ¬.">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            /* Light theme colors */
            --background: #ffffff;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #3b82f6;
            --radius: 0.5rem;
            --success-color: #22c55e;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            
            /* Sidebar specific */
            --sidebar-background: var(--card);
            --sidebar-foreground: var(--card-foreground);
            --sidebar-border: var(--border);
        }

        .dark {
            /* Dark theme colors */
            --background: #0f172a;
            --foreground: #f8fafc;
            --card: #1e293b;
            --card-foreground: #f8fafc;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #334155;
            --secondary-foreground: #f8fafc;
            --muted: #334155;
            --muted-foreground: #94a3b8;
            --accent: #334155;
            --accent-foreground: #f8fafc;
            --border: #334155;
            --input: #334155;
            --ring: #3b82f6;
            --success-color: #22c55e;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background-color: var(--background);
        }

        /* Sidebar Styles */
        .sidebar {
            background-color: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 20;
            width: 280px;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            height: 74px;
            display: flex;
            align-items: center;
        }

        .sidebar-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .tool-panel {
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
        }

        .panel-title-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Keep title and pulldown on a single row for style-section headers */
        .style-section.panel-title {
            justify-content: flex-start;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.75rem;
        }

        /* Fixed label width on the left; control fills remaining space */
        :root { --label-width: 120px; }
        .style-section.panel-title .panel-title-left { flex: 0 0 var(--label-width); min-width: var(--label-width); padding: 0 4px; }
        .style-section.panel-title .panel-inline-control { flex: 1 1 auto; min-width: 0; }


        .panel-inline-control {
            flex-shrink: 0;
            min-width: 120px;
        }

        .panel-inline-control select {
            width: 100%;
            font-size: 0.8rem;
        }


        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--foreground);
            text-decoration: none;
            min-height: 2.5rem;
        }

        .btn:hover {
            background-color: var(--muted);
        }

        .btn.primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .btn.primary:hover {
            background-color: var(--primary);
            opacity: 0.9;
        }

        .btn.btn-icon {
            padding: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            justify-content: center;
        }

        .btn.btn-icon .material-icons {
            margin: 0;
        }

        .btn.success {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn.success:hover {
            background-color: var(--success-color);
            opacity: 0.9;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }


        select {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
            min-height: 2.5rem;
        }

        select:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
            cursor: pointer;
        }


        .style-section {
            margin-bottom: 1rem;
        }

        /* Make clipboard paste button span full row */
        #clipboardButton { flex: 1 0 100%; }

        .style-subtitle {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted-foreground);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .footer-link {
            justify-content: flex-start;
            gap: 0.75rem;
            font-size: 0.825rem;
            color: var(--muted-foreground);
            text-decoration: none;
            background-color: transparent;
            border: none;
            padding: 0.75rem;
        }

        .footer-link:hover {
            background-color: var(--muted);
            color: var(--foreground);
        }

        .footer-link .material-icons {
            font-size: 1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
        }

        .top-bar {
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            height: 74px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            pointer-events: auto;
        }

        .top-bar h2 {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--foreground);
            margin: 0;
            flex: 1;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 110;
            pointer-events: auto;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--muted);
            position: relative;
            overflow: auto;
            padding: 2rem;
        }

        .canvas-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: transparent;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .canvas-container.empty {
            background: var(--card);
            border: 2px dashed var(--border);
        }

        .empty-state {
            text-align: center;
            color: var(--muted-foreground);
        }

        .empty-state .material-icons {
            font-size: 3rem;
            opacity: 0.5;
            margin-bottom: 1rem;
        }

        #imageCanvas {
            max-width: 100%;
            max-height: 100vh;
            border-radius: var(--radius);
            cursor: crosshair;
        }

        .transparent-background {
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Status Bar */
        .status-bar {
            background-color: var(--card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 2.5rem;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Message */
        #message {
            position: fixed;
            top: 90px;
            right: 20px;
            background-color: var(--card);
            color: var(--foreground);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            word-wrap: break-word;
            pointer-events: none;
        }

        #message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Right Layer Sidebar */
        .layer-sidebar {
            background-color: var(--card);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 6px -1px rgba(0, 0, 0, 0.1), -2px 0 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 20;
            width: 280px;
        }

        .layer-sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            height: 74px;
            display: flex;
            align-items: center;
        }

        .layer-sidebar-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .layer-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .layer-list {
            margin-bottom: 1rem;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: var(--muted);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-item:hover {
            background-color: var(--accent);
        }

        .layer-item.selected {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .layer-icon {
            font-size: 1.25rem;
        }

        .layer-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .layer-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .layer-visibility-toggle {
            background: none;
            border: none;
            color: currentColor;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .layer-visibility-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .layer-visibility-toggle.hidden {
            opacity: 0.5;
        }

        .layer-actions {
            margin-bottom: 1rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            min-height: 2rem;
        }

        /* Responsive Adjustments for Desktop Only */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            .layer-sidebar {
                width: 240px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .layer-sidebar {
                display: none;
            }
            
            .canvas-area {
                padding: 1rem;
            }
        }

        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="logo-section">
                    <span class="material-icons logo-icon">image</span>
                    <h1 class="logo-text">AnnotateShot</h1>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- File Operations -->
                <div class="tool-panel">
                    <div class="panel-title">
                        <span class="material-icons">folder_open</span>
                        <span data-lang-key="fileOperations">íŒŒì¼ ì‘ì—…</span>
                    </div>
                    <div class="btn-group">
                        <input type="file" id="imageLoader" accept="image/*" aria-label="Upload image file">
                        <div class="btn-row">
                            <button class="btn" id="clipboardButton" aria-label="Paste image from clipboard" title="Paste from Clipboard" style="height: 2.5rem;">
                                <span class="material-icons">content_paste</span>
                                <span data-lang-key="clipboard">í´ë¦½ë³´ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°</span>
                            </button>
                            <button class="btn btn-icon success" id="saveButton" aria-label="Save annotated image" title="Save Image">
                                <span class="material-icons">download</span>
                            </button>
                            <button class="btn btn-icon" id="copyToClipboardButton" aria-label="Copy to clipboard" title="Copy to Clipboard">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn btn-icon" id="undoButton" aria-label="Undo last action">
                                <span class="material-icons">undo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Canvas Settings -->
                <div class="tool-panel">
                    <div class="panel-title">
                        <div class="panel-title-left">
                            <span class="material-icons">palette</span>
                            <span data-lang-key="canvasSettings">ìº”ë²„ìŠ¤ ì„¤ì •</span>
                        </div>
                    </div>
                    <div class="style-section">
                        <div class="style-subtitle" data-lang-key="canvasMode">ìº”ë²„ìŠ¤ ëª¨ë“œ</div>
                        <select id="canvasModeSelector" aria-label="Select canvas mode">
                            <option value="single" data-lang-key="singleImageMode">ì‹±ê¸€ ì´ë¯¸ì§€ í¸ì§‘</option>
                            <option value="multi" data-lang-key="multiImageMode">ë¹ˆ ìº”ë²„ìŠ¤ (ë©€í‹° ì´ë¯¸ì§€)</option>
                        </select>
                    </div>
                    <div class="style-section" id="backgroundColorSection" style="display: none;">
                        <div class="style-subtitle" data-lang-key="backgroundColor">ë°°ê²½ìƒ‰</div>
                        <select id="backgroundColorSelector" aria-label="Select background color">
                            <option value="" data-lang-key="pleaseSelect">ë°°ê²½ìƒ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="transparent" data-lang-key="transparent">íˆ¬ëª…</option>
                            <option value="white" data-lang-key="white">í°ìƒ‰</option>
                            <option value="light-gray" data-lang-key="lightGray">ì—°í•œ íšŒìƒ‰</option>
                            <option value="gray" data-lang-key="gray">íšŒìƒ‰</option>
                            <option value="dark-gray" data-lang-key="darkGray">ì§™ì€ íšŒìƒ‰</option>
                        </select>
                    </div>
                    <div class="style-section" id="canvasSizeSection" style="display: none;">
                        <div class="style-subtitle" data-lang-key="canvasSize">ìº”ë²„ìŠ¤ í¬ê¸°</div>
                        <select id="canvasSizeSelector" aria-label="Select canvas size">
                            <option value="" data-lang-key="pleaseSelectSize">ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="1920x1080" data-lang-key="size1920x1080">Full HD (1920Ã—1080)</option>
                            <option value="1280x720" data-lang-key="size1280x720">HD (1280Ã—720)</option>
                            <option value="1200x800" data-lang-key="size1200x800">ì›¹ í‘œì¤€ (1200Ã—800)</option>
                            <option value="800x600" data-lang-key="size800x600">í´ë˜ì‹ (800Ã—600)</option>
                            <option value="a4-landscape" data-lang-key="sizeA4Landscape">A4 ê°€ë¡œ (297Ã—210mm)</option>
                            <option value="a4-portrait" data-lang-key="sizeA4Portrait">A4 ì„¸ë¡œ (210Ã—297mm)</option>
                            <option value="custom" data-lang-key="sizeCustom">ì‚¬ìš©ì ì •ì˜</option>
                        </select>
                        <div id="customSizeSection" style="display: none; margin-top: 10px;">
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="number" id="customWidth" placeholder="ê°€ë¡œ" min="100" max="2000" style="width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <span>Ã—</span>
                                <input type="number" id="customHeight" placeholder="ì„¸ë¡œ" min="100" max="2000" style="width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <button id="applyCustomSize" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px; background: #f5f5f5; cursor: pointer;" data-lang-key="apply">ì ìš©</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Drawing Mode -->
                <div class="tool-panel">
                    <div class="panel-title">
                        <div class="panel-title-left">
                            <span class="material-icons">brush</span>
                            <span data-lang-key="annotationMode">ì£¼ì„ ëª¨ë“œ</span>
                        </div>
                    </div>
                    <div class="style-section">
                        <select id="modeSelector" aria-label="Select annotation mode">
                            <option value="number" data-lang-key="numberMode">ìˆ«ì ì…ë ¥ ëª¨ë“œ</option>
                            <option value="shape" data-lang-key="shapeMode">ë„í˜• ëª¨ë“œ</option>
                            <option value="text" data-lang-key="textMode">í…ìŠ¤íŠ¸ ëª¨ë“œ</option>
                            <option value="emoji" data-lang-key="emojiMode">ì´ëª¨ì§€ ëª¨ë“œ</option>
                            <option value="crop" data-lang-key="cropMode">í¬ë¡­ ëª¨ë“œ</option>
                        </select>
                    </div>
                </div>

                <!-- Style Panel -->
                <div class="tool-panel">
                    <div class="panel-title">
                        <span class="material-icons">palette</span>
                        <span data-lang-key="style">ìŠ¤íƒ€ì¼</span>
                    </div>
                    
                    <!-- Color Section -->
                    <div class="style-section panel-title" id="colorSection">
                        <div class="panel-title-left">
                            <span data-lang-key="color">ìƒ‰ìƒ</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="colorSelector" aria-label="Select annotation color">
                                <option value="#FF0000" data-lang-key="red">ë¹¨ê°„ìƒ‰</option>
                                <option value="#FF8000" data-lang-key="orange">ì£¼í™©ìƒ‰</option>
                                <option value="#00FF00" data-lang-key="green">ë…¹ìƒ‰</option>
                                <option value="#0000FF" data-lang-key="blue">íŒŒë‘ìƒ‰</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Size Section -->
                    <div class="style-section panel-title" id="sizeSection">
                        <div class="panel-title-left">
                            <span data-lang-key="size">í¬ê¸°</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="sizeSelector" aria-label="Select annotation size">
                                <option value="10">10px</option>
                                <option value="15">15px</option>
                                <option value="20" selected>20px</option>
                                <option value="25">25px</option>
                                <option value="30">30px</option>
                                <option value="35">35px</option>
                                <option value="40">40px</option>
                                <option value="45">45px</option>
                                <option value="50">50px</option>
                                <option value="55">55px</option>
                                <option value="60">60px</option>
                                <option value="65">65px</option>
                                <option value="70">70px</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Line Width Section (Shape mode only) -->
                    <div class="style-section panel-title" id="lineWidthSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="lineWidth">êµµê¸°</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="lineWidthSelector" aria-label="Select line width">
                                <option value="1" data-lang-key="thin">ì–‡ìŒ</option>
                                <option value="2" selected data-lang-key="normal">ë³´í†µ</option>
                                <option value="4" data-lang-key="thick">ë‘êº¼ì›€</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shape Section (Shape mode only) -->
                    <div class="style-section panel-title" id="shapeSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="shape">ëª¨ì–‘</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="shapeSelector" aria-label="Select shape type">
                                <option value="rectangle" data-lang-key="rectangle">ì‚¬ê°í˜•</option>
                                <option value="circle" data-lang-key="circle">ì›</option>
                                <option value="arrow" data-lang-key="arrow">í™”ì‚´í‘œ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Fill Section (Shape mode only, not for arrows) -->
                    <div class="style-section panel-title" id="fillSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="fill">ì±„ìš°ê¸°</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="fillSelector" aria-label="Select fill type">
                                <option value="none" data-lang-key="fillNone">í…Œë‘ë¦¬ë§Œ</option>
                                <option value="solid" data-lang-key="fillSolid">ë‹¨ìƒ‰ ì±„ìš°ê¸°</option>
                                <option value="blur" data-lang-key="fillBlur">íë¦¼ íš¨ê³¼</option>
                                <option value="mosaic" data-lang-key="fillMosaic">ëª¨ìì´í¬</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Emoji Section (Emoji mode only) -->
                    <div class="style-section panel-title" id="emojiSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="emojiType">ì´ëª¨ì§€ ì¢…ë¥˜</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="emojiSelector" aria-label="Select emoji">
                                <option value="ğŸ˜€">ğŸ˜€</option>
                                <option value="ğŸ˜">ğŸ˜</option>
                                <option value="ğŸ¤”">ğŸ¤”</option>
                                <option value="ğŸ‘">ğŸ‘</option>
                                <option value="ğŸ‘">ğŸ‘</option>
                                <option value="â¤ï¸">â¤ï¸</option>
                                <option value="â­">â­</option>
                                <option value="ğŸ”¥">ğŸ”¥</option>
                                <option value="ğŸ’¯">ğŸ’¯</option>
                                <option value="âœ…">âœ…</option>
                                <option value="âŒ">âŒ</option>
                                <option value="âš ï¸">âš ï¸</option>
                            </select>
                        </div>
                    </div>

                    <!-- Crop Section (Crop mode only) -->
                    <div class="style-section panel-title" id="cropSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="cropStyle">í¬ë¡­ ìŠ¤íƒ€ì¼</span>
                        </div>
                        <div class="panel-inline-control">
                            <select id="cropStyleSelector" aria-label="Select crop style">
                                <option value="basic" data-lang-key="cropBasic">ê¸°ë³¸ í¬ë¡­</option>
                                <option value="torn" data-lang-key="cropTorn">ì°¢ì–´ì§„ ì¢…ì´</option>
                            </select>
                        </div>
                    </div>

                    <!-- Crop Controls Section -->
                    <div class="style-section panel-title" id="cropControlsSection" style="display: none;">
                        <div class="panel-title-left">
                            <span data-lang-key="cropControls">í¬ë¡­ ì»¨íŠ¸ë¡¤</span>
                        </div>
                        <div class="panel-inline-control">
                            <button id="applyCropButton" class="btn btn-primary" data-lang-key="applyCrop" disabled>í¬ë¡­ ì ìš©</button>
                        </div>
                        <div class="crop-info" id="cropInfo" style="display: none; margin-top: 8px; font-size: 12px; color: #666; grid-column: 1 / -1;">
                            <span data-lang-key="cropInstruction">ë“œë˜ê·¸í•˜ì—¬ í¬ë¡­ ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer" style="padding: 1rem;">
                <div class="btn-group">
                    <!-- Footer Links -->
                    <div class="footer-links">
                        <a href="#" class="btn footer-link" onclick="showAbout()">
                            <span class="material-icons">info</span>
                            <span>About AnnotateShot</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <h2 data-lang-key="editImage">ì´ë¯¸ì§€ í¸ì§‘</h2>
                <div class="top-bar-actions">
                    <label for="resizeSelector" style="font-size: 0.875rem; color: var(--muted-foreground); margin-right: 0.5rem; pointer-events: none; white-space: nowrap;" data-lang-key="imageSize">ì´ë¯¸ì§€ í¬ê¸°:</label>
                    <select id="resizeSelector" aria-label="Select image resize option" class="top-resize-selector" onclick="event.stopPropagation();">
                        <option value="default" selected data-lang-key="autoResize">ìë™ ë¦¬ì‚¬ì´ì¦ˆ (ê¸°ë³¸)</option>
                        <option value="original" data-lang-key="originalSize">ì›ë³¸</option>
                        <option value="300" data-lang-key="width300">ë„ˆë¹„ 300</option>
                        <option value="600" data-lang-key="width600">ë„ˆë¹„ 600</option>
                        <option value="900" data-lang-key="width900">ë„ˆë¹„ 900</option>
                        <option value="scale30" data-lang-key="scale30">ì›ë³¸ ëŒ€ë¹„ 30% ì¶•ì†Œ</option>
                        <option value="scale50" data-lang-key="scale50">ì›ë³¸ ëŒ€ë¹„ 50% ì¶•ì†Œ</option>
                        <option value="scale70" data-lang-key="scale70">ì›ë³¸ ëŒ€ë¹„ 70% ì¶•ì†Œ</option>
                    </select>
                    <button class="btn btn-icon" id="themeToggle" aria-label="Toggle theme">
                        <span class="material-icons">dark_mode</span>
                    </button>
                </div>
            </header>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="canvas-container empty" id="canvasContainer">
                    <div class="empty-state" id="emptyState">
                        <div class="material-icons">image</div>
                        <div id="uploadPromptText" data-lang-key="uploadImagePrompt">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”</div>
                    </div>
                    <canvas id="imageCanvas" style="display: none;"></canvas>
                </div>
            </div>

            <!-- Status Bar -->
            <footer class="status-bar">
                <div class="status-info" id="statusInfo">
                    <span id="statusText" data-lang-key="mouseMovePrompt">ë§ˆìš°ìŠ¤ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”</span>
                </div>
            </footer>
        </main>

        <!-- Right Layer Sidebar -->
        <aside class="layer-sidebar" id="layerSidebar">
            <div class="layer-sidebar-header">
                <div class="layer-sidebar-header-content">
                    <span class="material-icons">layers</span>
                    <h3 data-lang-key="layers">ë ˆì´ì–´</h3>
                </div>
            </div>
            
            <div class="layer-sidebar-content">
                <div class="layer-list" id="layerList">
                    <div class="layer-item background-layer">
                        <div class="layer-info">
                            <span class="material-icons layer-icon">image</span>
                            <span class="layer-name" data-lang-key="backgroundLayer">ë°°ê²½ ì´ë¯¸ì§€</span>
                        </div>
                        <div class="layer-controls">
                            <button class="layer-visibility-toggle" aria-label="Toggle visibility">
                                <span class="material-icons">visibility</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="layer-actions">
                    <button class="btn btn-sm" id="clearAllLayers" data-lang-key="clearAllLayers">
                        <span class="material-icons">clear_all</span>
                        ëª¨ë“  ë ˆì´ì–´ ì§€ìš°ê¸°
                    </button>
                </div>

                <!-- Language Selector in Layer Sidebar -->
                <div class="layer-language" style="border-top: 1px solid var(--border); margin-top: 0.75rem; padding: 16px;">
                    <label for="languageSelector" style="display:block; font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem;" data-lang-key="language">ì–¸ì–´</label>
                    <select id="languageSelector" aria-label="Select language" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--muted); color: var(--foreground); border: 1px solid var(--border); border-radius: var(--radius);">
                        <option value="en">English</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                    </select>
                </div>
            </div>
        </aside>
    </div>

    <!-- Message -->
    <div id="message"></div>

    <script>
        // Embedded main.js content starts here
        // ì „ì—­ ìƒìˆ˜ ë° ë³€ìˆ˜
        const MAX_WIDTH = 1400;
        const MAX_HEIGHT = 900;
        
        // Remove mobile detection since we're desktop only
        const imageLoader = document.getElementById('imageLoader');
        const clipboardButton = document.getElementById('clipboardButton');
        const saveButton = document.getElementById('saveButton');
        const copyToClipboardButton = document.getElementById('copyToClipboardButton');
        const undoButton = document.getElementById('undoButton');
        const colorSelector = document.getElementById('colorSelector');
        const sizeSelector = document.getElementById('sizeSelector');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        
        // ë©”ì¸ ìº”ë²„ìŠ¤ ê³ í™”ì§ˆ ì„¤ì •
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        const messageDiv = document.getElementById('message');
        const modeSelector = document.getElementById('modeSelector');
        const shapeSelector = document.getElementById('shapeSelector');
        const emojiSelector = document.getElementById('emojiSelector');
        const fillSelector = document.getElementById('fillSelector');
        const lineWidthSelector = document.getElementById('lineWidthSelector');
        const resizeSelector = document.getElementById('resizeSelector');
        const backgroundColorSelector = document.getElementById('backgroundColorSelector');
        const canvasModeSelector = document.getElementById('canvasModeSelector');
        const canvasSizeSelector = document.getElementById('canvasSizeSelector');
        const customWidth = document.getElementById('customWidth');
        const customHeight = document.getElementById('customHeight');
        const applyCustomSize = document.getElementById('applyCustomSize');

        // ìº”ë²„ìŠ¤ ëª¨ë“œ ì‹œìŠ¤í…œ
        let canvasMode = 'single'; // 'single' (ê¸°ë³¸) ë˜ëŠ” 'multi' (ë¹ˆ ìº”ë²„ìŠ¤)
        let canvasBackgroundColor = ''; // ë¬´ì§€ ë°°ê²½ìƒ‰ (ë©€í‹° ëª¨ë“œ ì „ìš©) - ê¸°ë³¸ê°’: ì„ íƒ ì•ˆí•¨
        let canvasSize = ''; // ë©€í‹° ëª¨ë“œ ì „ìš© ìº”ë²„ìŠ¤ í¬ê¸° - ê¸°ë³¸ê°’: ì„ íƒ ì•ˆí•¨
        let imageLayers = []; // ì´ë¯¸ì§€ ë ˆì´ì–´ë“¤ (ë©€í‹° ëª¨ë“œ ì „ìš©)
        let currentImage = null; // ì‹±ê¸€ ëª¨ë“œì—ì„œ ì‚¬ìš©
        let layers = []; // New layer system: [{ type, data, visible, id }, ...]
        let layerIdCounter = 0;
        let currentColor = "#FF0000";
        let currentSize = "20";
        let currentMode = 'number';
        let currentShape = 'rectangle';
        let currentFill = 'none';
        let isDrawing = false;
        let startX, startY;
        let shapeCount = 0;
        let clicks = [];
        let undoStack = [];
        let clickCount = 0;
        let maxClickCount = 0;
        let isWaitingForClick = false;
        let pendingNumber = null;
        let currentLineWidth = 2; // ê¸°ë³¸ê°’: ë³´í†µ
        let isHorizontalLock = false;
        let isVerticalLock = false;
        let initialX = null;
        let initialY = null;

        // ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
        let isDragging = false;
        let draggedObject = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ê´€ë ¨ ë³€ìˆ˜
        let selectedImageLayer = null;
        let isResizing = false;
        let resizeHandle = null; // 'nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'
        let resizeStartX = 0;
        let resizeStartY = 0;
        let resizeStartWidth = 0;
        let resizeStartHeight = 0;
        let resizeStartImageX = 0;
        let resizeStartImageY = 0;

        // í¬ë¡­ ê´€ë ¨ ë³€ìˆ˜
        let isCropping = false;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropEndX = 0;
        let cropEndY = 0;
        let currentCropStyle = 'basic';
        let cropPreviewMode = false;

        // ë””ë°”ìš´ì‹± ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ì–¸ì–´ ê´€ë ¨ í•¨ìˆ˜ë“¤ (simplified for standalone)
        let currentLanguage = 'ko';
        
        function getLanguage() {
            return localStorage.getItem('language') || 'ko';
        }
        
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            applyLanguage();
        }
        
        function translate(key, params = {}) {
            const translations = {
                'ko': {
                    'uploadImagePrompt': 'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”',
                    'imageLoaded': 'ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤',
                    'noImageLoaded': 'ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
                    'imageLayerAdded': 'ì´ë¯¸ì§€ ë ˆì´ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
                    'mouseMovePrompt': 'ë§ˆìš°ìŠ¤ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”',
                    'fileOperations': 'íŒŒì¼ ì‘ì—…',
                    'clipboard': 'í´ë¦½ë³´ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°',
                    'editImage': 'ì´ë¯¸ì§€ í¸ì§‘',
                    'canvasSettings': 'ìº”ë²„ìŠ¤ ì„¤ì •',
                    'annotationMode': 'ì£¼ì„ ëª¨ë“œ',
                    'style': 'ìŠ¤íƒ€ì¼',
                    'color': 'ìƒ‰ìƒ',
                    'size': 'í¬ê¸°',
                    'layers': 'ë ˆì´ì–´'
                },
                'en': {
                    'uploadImagePrompt': 'Upload an image or paste from clipboard',
                    'imageLoaded': 'Image loaded',
                    'noImageLoaded': 'No image loaded',
                    'imageLayerAdded': 'Image layer added',
                    'mouseMovePrompt': 'Move your mouse',
                    'fileOperations': 'File Operations',
                    'clipboard': 'Paste from Clipboard',
                    'editImage': 'Edit Image',
                    'canvasSettings': 'Canvas Settings',
                    'annotationMode': 'Annotation Mode',
                    'style': 'Style',
                    'color': 'Color',
                    'size': 'Size',
                    'layers': 'Layers'
                }
            };
            
            const langTranslations = translations[currentLanguage] || translations['ko'];
            let text = langTranslations[key] || key;
            
            // Simple parameter replacement
            Object.keys(params).forEach(param => {
                text = text.replace(`{${param}}`, params[param]);
            });
            
            return text;
        }
        
        function applyLanguage() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                element.textContent = translate(key);
            });
        }

        // ì–¸ì–´ ì„ íƒê¸° ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const langSelect = document.getElementById('languageSelector');
            if (langSelect) {
                langSelect.value = getLanguage();
                langSelect.addEventListener('change', (e) => setLanguage(e.target.value));
            }
            // ìµœì´ˆ ì ìš©
            try { applyLanguage(); } catch (e) { /* noop */ }
        });

        // ì´ë¯¸ì§€ ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜
        function loadImageFromUrl(url) {
            const storageKey = 'cachedImage_' + url;
            const cachedImage = localStorage.getItem(storageKey);
            if (cachedImage) {
                loadImageFromDataUrl(cachedImage);
                return;
            }
            currentImage = new Image();
            currentImage.crossOrigin = "anonymous";
            currentImage.onload = () => {
                applyImageToCanvas();
                cacheImageToLocalStorage(currentImage, url);
            };
            currentImage.onerror = () => {
                console.error("Image load failed:", url);
                messageDiv.textContent = translate('defaultImageLoadFailed');
            };
            currentImage.src = url;
        }

        function loadImageFromDataUrl(dataUrl) {
            const imageSizeKB = Math.round(dataUrl.length / 1024);
            console.log('loadImageFromDataUrl í˜¸ì¶œ, ë°ì´í„° í¬ê¸°:', imageSizeKB, 'KB');
            
            currentImage = new Image();
            currentImage.onload = () => {
                console.log('ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', currentImage.width + 'x' + currentImage.height);
                
                try {
                    applyImageToCanvas();
                    messageDiv.textContent = translate('imageLoaded');
                } catch (error) {
                    console.error('ìº”ë²„ìŠ¤ ì ìš© ì˜¤ë¥˜:', error);
                    messageDiv.textContent = 'ì´ë¯¸ì§€ ìº”ë²„ìŠ¤ ì ìš© ì‹¤íŒ¨: ' + error.message;
                }
            };
            
            currentImage.onerror = (error) => {
                console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                messageDiv.textContent = 'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ì†ìƒëœ ì´ë¯¸ì§€ ë°ì´í„°';
            };
            
            try {
                currentImage.src = dataUrl;
            } catch (error) {
                console.error('ì´ë¯¸ì§€ src ì„¤ì • ì˜¤ë¥˜:', error);
                messageDiv.textContent = 'ì´ë¯¸ì§€ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message;
            }
        }

        // ìº”ë²„ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function calculateImageDimensions(imgWidth, imgHeight) {
            const sidebarWidth = 280;
            const layerSidebarWidth = 280;
            const availableWidth = window.innerWidth - sidebarWidth - layerSidebarWidth - 64;
            const availableHeight = window.innerHeight - 200;
            
            const maxWidth = Math.min(MAX_WIDTH, Math.max(400, availableWidth));
            const maxHeight = Math.min(MAX_HEIGHT, Math.max(300, availableHeight));
            
            // ë¦¬ì‚¬ì´ì¦ˆ ì˜µì…˜ì— ë”°ë¼ í¬ê¸° ê³„ì‚°
            const resizeValue = resizeSelector.value;
            
            if (resizeValue === 'original') {
                return { width: imgWidth, height: imgHeight };
            }
            
            if (resizeValue === 'default') {
                // ìë™ ë¦¬ì‚¬ì´ì¦ˆ: í™”ë©´ì— ë§ê²Œ ì¡°ì •
                const aspectRatio = imgWidth / imgHeight;
                
                if (aspectRatio > maxWidth / maxHeight) {
                    return { width: maxWidth, height: maxWidth / aspectRatio };
                } else {
                    return { width: maxHeight * aspectRatio, height: maxHeight };
                }
            }
            
            // ê³ ì • ë„ˆë¹„ ì˜µì…˜ë“¤
            if (['300', '600', '900'].includes(resizeValue)) {
                const targetWidth = parseInt(resizeValue);
                const aspectRatio = imgWidth / imgHeight;
                return { width: targetWidth, height: targetWidth / aspectRatio };
            }
            
            // ë¹„ìœ¨ ì¶•ì†Œ ì˜µì…˜ë“¤
            if (resizeValue.startsWith('scale')) {
                const scale = parseInt(resizeValue.replace('scale', '')) / 100;
                return { width: imgWidth * scale, height: imgHeight * scale };
            }
            
            return { width: maxWidth, height: maxHeight };
        }

        function applyCanvasDimensions(width, height) {
            // High DPI ì§€ì›
            const dpr = window.devicePixelRatio || 1;
            
            // Canvas ì‹¤ì œ í¬ê¸° ì„¤ì • (High DPI ê³ ë ¤)
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // Canvas CSS í¬ê¸° ì„¤ì •
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            // Context scaling ì ìš©
            ctx.scale(dpr, dpr);
            
            // ê³ í™”ì§ˆ ì„¤ì • ìœ ì§€
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
        }

        function getSidebarWidth() {
            return 280; // Fixed sidebar width for desktop
        }

        function getLayerSidebarWidth() {
            return 280; // Fixed layer sidebar width for desktop
        }

        function drawCanvasBackground() {
            // ë°°ê²½ìƒ‰ì— ë”°ë¼ ìº”ë²„ìŠ¤ ë°°ê²½ ê·¸ë¦¬ê¸°
            if (canvasBackgroundColor === 'transparent') {
                // íˆ¬ëª… ë°°ê²½ì˜ ê²½ìš° ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ì§€ ì•ŠìŒ (ì§„ì§œ íˆ¬ëª…)
                // ì‹œê°ì  í‘œì‹œëŠ” CSSë¡œ ì²˜ë¦¬
                updateCanvasTransparencyVisual();
            } else {
                // íˆ¬ëª…ì´ ì•„ë‹Œ ê²½ìš° CSS ë°°ê²½ ì œê±°
                canvas.classList.remove('transparent-background');
                const colorMap = {
                    'white': '#ffffff',
                    'light-gray': '#f5f7fa', 
                    'gray': '#e0e0e0',
                    'dark-gray': '#808080'
                };
                ctx.fillStyle = colorMap[canvasBackgroundColor] || '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function updateCanvasTransparencyVisual() {
            // íˆ¬ëª… ë°°ê²½ì¼ ë•Œ CSS í´ë˜ìŠ¤ ì¶”ê°€ (ì‹œê°ì  í‘œì‹œìš©)
            canvas.classList.add('transparent-background');
        }

        function drawSingleModeDefaultCanvas() {
            // ì‹±ê¸€ ëª¨ë“œ ê¸°ë³¸ ìº”ë²„ìŠ¤ (ì•ˆë‚´ ë¬¸êµ¬ í¬í•¨)
            console.log('Drawing single mode default canvas'); // ë””ë²„ê·¸ìš©
            
            // ìº”ë²„ìŠ¤ í´ë˜ìŠ¤ ì •ë¦¬
            canvas.classList.remove('transparent-background');
            canvas.classList.add('default-canvas');
            
            // í™”ë©´ í¬ê¸°ì— ë§ëŠ” ì ì ˆí•œ ê¸°ë³¸ ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚° (ê¸°ì¡´ prodì™€ ë™ì¼í•œ ë¡œì§)
            const sidebarWidth = getSidebarWidth();
            const layerSidebarWidth = getLayerSidebarWidth();
            const availableWidth = window.innerWidth - sidebarWidth - layerSidebarWidth - 64;
            const availableHeight = window.innerHeight - 200; // ìƒë‹¨/í•˜ë‹¨ ì—¬ë°±
            
            const maxWidth = Math.min(MAX_WIDTH, Math.max(400, availableWidth));
            const maxHeight = Math.min(MAX_HEIGHT, Math.max(300, availableHeight));
            
            applyCanvasDimensions(maxWidth, maxHeight);
            
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ (uploadImagePrompt ì‚¬ìš©)
            const text = translate('uploadImagePrompt');
            const lines = text.split('\n');
            
            ctx.fillStyle = '#555';
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const lineHeight = 30;
            // CSS í”½ì…€ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (applyCanvasDimensionsì—ì„œ ctx.scaleì´ ì ìš©ë˜ë¯€ë¡œ)
            const canvasWidth = parseInt(canvas.style.width);
            const canvasHeight = parseInt(canvas.style.height);
            const startY = canvasHeight / 2 - (lines.length - 1) * lineHeight / 2;
            
            lines.forEach((line, index) => {
                ctx.fillText(line, canvasWidth / 2, startY + index * lineHeight);
            });
            
            console.log('Single mode default canvas drawn successfully'); // ë””ë²„ê·¸ìš©
        }

        function createImageLayer(image, x = 0, y = 0, width = null, height = null) {
            return {
                id: layerIdCounter++,
                image: image,
                x: x,
                y: y,
                width: width || image.width,
                height: height || image.height,
                visible: true
            };
        }

        function applyImageToCanvas() {
            if (!currentImage) {
                if (canvasMode === 'multi') {
                    // ë©€í‹° ëª¨ë“œ: ë¹ˆ ìº”ë²„ìŠ¤ í‘œì‹œ
                    drawBlankMultiCanvas();
                } else {
                    // ì‹±ê¸€ ëª¨ë“œ: ê¸°ë³¸ ìº”ë²„ìŠ¤ í‘œì‹œ
                    drawSingleModeDefaultCanvas();
                    messageDiv.textContent = translate('noImageLoaded');
                }
                resetDrawingState();
                return;
            }

            if (canvasMode === 'single') {
                // ì‹±ê¸€ ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹ (ì´ë¯¸ì§€ì— ë§ì¶° ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •)
                applySingleImageMode();
            } else {
                // ë©€í‹° ëª¨ë“œ: ì´ë¯¸ì§€ë¥¼ ë ˆì´ì–´ë¡œ ì¶”ê°€
                applyMultiImageMode();
            }
        }

        function applySingleImageMode() {
            // ê¸°ì¡´ ì‹±ê¸€ ì´ë¯¸ì§€ í¸ì§‘ ë°©ì‹
            const { width, height } = calculateImageDimensions(currentImage.width, currentImage.height);
            applyCanvasDimensions(width, height);
            
            // ë ˆì´ì–´ ì‹œìŠ¤í…œì— ì¶”ê°€ (UI í˜¸í™˜ì„± ìœ„í•´)
            createBackgroundImageLayer();
            
            // ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            redrawCanvas();
            
            // ë ˆì´ì–´ UI ì—…ë°ì´íŠ¸
            if (typeof window.updateLayerList === 'function') {
                window.updateLayerList();
            }
            
            resetDrawingState();
            showMessage(translate('imageLoaded', { width, height }));
        }

        function applyMultiImageMode() {
            if (imageLayers.length === 0) {
                // ì²« ë²ˆì§¸ ì´ë¯¸ì§€: ì„¤ì •ëœ ìº”ë²„ìŠ¤ í¬ê¸° ì‚¬ìš©
                const { width, height } = getCanvasSize();
                applyCanvasDimensions(width, height);
                
                // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ë§ê²Œ ë¦¬ì‚¬ì´ì¦ˆ
                const imageAspectRatio = currentImage.width / currentImage.height;
                const canvasAspectRatio = width / height;
                
                let imageWidth, imageHeight, x, y;
                
                if (imageAspectRatio > canvasAspectRatio) {
                    // ì´ë¯¸ì§€ê°€ ìº”ë²„ìŠ¤ë³´ë‹¤ ê°€ë¡œë¡œ ê¸¸ ê²½ìš°
                    imageWidth = Math.min(width * 0.9, currentImage.width);
                    imageHeight = imageWidth / imageAspectRatio;
                } else {
                    // ì´ë¯¸ì§€ê°€ ìº”ë²„ìŠ¤ë³´ë‹¤ ì„¸ë¡œë¡œ ê¸¸ê±°ë‚˜ ë¹„ìŠ·í•œ ê²½ìš°
                    imageHeight = Math.min(height * 0.9, currentImage.height);
                    imageWidth = imageHeight * imageAspectRatio;
                }
                
                // ì¤‘ì•™ì— ë°°ì¹˜
                x = (width - imageWidth) / 2;
                y = (height - imageHeight) / 2;
                
                // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ë ˆì´ì–´ ì¶”ê°€
                const imageLayer = createImageLayer(
                    currentImage, 
                    x, y,  
                    imageWidth, imageHeight
                );
                imageLayers.push(imageLayer);
                
                showMessage(translate('imageLoaded', { 
                    width: Math.round(imageWidth), 
                    height: Math.round(imageHeight) 
                }));
            } else {
                // ì¶”ê°€ ì´ë¯¸ì§€ë“¤: ìº”ë²„ìŠ¤ í¬ê¸° ìœ ì§€, ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ë§ê²Œ ë¦¬ì‚¬ì´ì¦ˆí•˜ì—¬ ì¶”ê°€
                addImageAsNewLayer();
                return;
            }
            
            // ì „ì—­ imageLayers ì—…ë°ì´íŠ¸
            window.imageLayers = imageLayers;
            
            // ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            redrawCanvas();
            
            // ë ˆì´ì–´ UI ì—…ë°ì´íŠ¸
            if (typeof window.updateLayerList === 'function') {
                window.updateLayerList();
            }
            
            resetDrawingState();
        }

        function getCanvasSize() {
            // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ë°˜í™˜
            if (!canvasSize || canvasSize === '') {
                return { width: 1200, height: 800 };
            }
            
            if (canvasSize === 'custom') {
                const width = parseInt(customWidth.value) || 1200;
                const height = parseInt(customHeight.value) || 800;
                return { width, height };
            }
            
            const sizeMap = {
                '1920x1080': { width: 1920, height: 1080 },
                '1280x720': { width: 1280, height: 720 },
                '1200x800': { width: 1200, height: 800 },
                '800x600': { width: 800, height: 600 },
                'a4-landscape': { width: 1122, height: 794 }, // A4 297Ã—210mm at 96 DPI
                'a4-portrait': { width: 794, height: 1122 }   // A4 210Ã—297mm at 96 DPI
            };
            
            return sizeMap[canvasSize] || { width: 1200, height: 800 };
        }

        function drawBlankMultiCanvas() {
            // ìº”ë²„ìŠ¤ í¬ê¸°ë‚˜ ë°°ê²½ìƒ‰ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ì§€ ì•ŠìŒ
            const canvasSizeData = getCanvasSize();
            if (!canvasBackgroundColor || canvasBackgroundColor === '') {
                // ìº”ë²„ìŠ¤ë¥¼ ê¸°ë³¸ í¬ê¸°ë¡œ ì´ˆê¸°í™”í•˜ë˜ ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ì§€ ì•ŠìŒ
                canvas.classList.remove('default-canvas', 'transparent-background');
                applyCanvasDimensions(800, 600); // ìµœì†Œ í¬ê¸°
                return;
            }
            
            // ì„¤ì •ì´ ëª¨ë‘ ì„ íƒëœ ê²½ìš°ì—ë§Œ ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
            const { width, height } = canvasSizeData;
            applyCanvasDimensions(width, height);
            
            drawCanvasBackground();
            
            const text = "ë©€í‹° ì´ë¯¸ì§€ ëª¨ë“œ\nì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ë³´ì„¸ìš”";
            const lines = text.split('\n');
            
            ctx.fillStyle = '#888';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const lineHeight = 35;
            const startY = canvas.height / 2 - (lines.length - 1) * lineHeight / 2;
            
            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, startY + index * lineHeight);
            });
        }

        // ìº”ë²„ìŠ¤ ë ˆì´ì–´ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function createBackgroundImageLayer() {
            createBackgroundImageLayerWithSize(canvas.width, canvas.height);
        }

        function createBackgroundImageLayerWithSize(width, height) {
            // Remove existing background layer if any
            layers = layers.filter(layer => layer.type !== 'background');
            
            // Add new background layer
            const backgroundLayer = {
                id: layerIdCounter++,
                type: 'background',
                data: {
                    image: currentImage,
                    width: width,
                    height: height
                },
                visible: true,
                name: 'Background Image'
            };
            
            // Background layer should be at the bottom
            layers.unshift(backgroundLayer);
            
            // Update global reference
            window.layers = layers;
        }

        function resetDrawingState() {
            isDragging = false;
            draggedObject = null;
            isDrawing = false;
            isWaitingForClick = false;
            pendingNumber = null;
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text) {
            messageDiv.textContent = text;
            messageDiv.classList.add('show');
            
            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 3000);
        }

        // ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function redrawCanvas() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (canvasMode === 'single' && currentImage) {
                // Single mode: draw the main image
                const canvasWidth = parseInt(canvas.style.width);
                const canvasHeight = parseInt(canvas.style.height);
                ctx.drawImage(currentImage, 0, 0, canvasWidth, canvasHeight);
            } else if (canvasMode === 'multi') {
                // Multi mode: draw background first
                if (canvasBackgroundColor && canvasBackgroundColor !== '') {
                    drawCanvasBackground();
                }
                
                // Draw image layers
                imageLayers.forEach(layer => {
                    if (layer.visible !== false) {
                        ctx.drawImage(layer.image, layer.x, layer.y, layer.width, layer.height);
                    }
                });
            }
            
            // Draw all annotations
            clicks.forEach(click => {
                if (click.visible !== false) {
                    drawAnnotation(click);
                }
            });
            
            // Update canvas display
            canvas.style.display = 'block';
            document.getElementById('canvasContainer').classList.remove('empty');
            document.getElementById('emptyState').style.display = 'none';
        }

        function drawAnnotation(click) {
            ctx.save();
            
            switch (click.type) {
                case 'number':
                    drawNumber(click);
                    break;
                case 'shape':
                    drawShape(click);
                    break;
                case 'text':
                    drawText(click);
                    break;
                case 'emoji':
                    drawEmoji(click);
                    break;
            }
            
            ctx.restore();
        }

        function drawNumber(click) {
            const fontSize = parseInt(click.size);
            const radius = fontSize * 0.8;
            
            // Draw circle background
            ctx.fillStyle = click.color;
            ctx.beginPath();
            ctx.arc(click.x, click.y, radius, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw number text
            ctx.fillStyle = 'white';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(click.number, click.x, click.y);
        }

        function drawShape(click) {
            ctx.strokeStyle = click.color;
            ctx.lineWidth = click.lineWidth || 2;
            ctx.fillStyle = click.color;
            
            const width = click.endX - click.startX;
            const height = click.endY - click.startY;
            
            if (click.shape === 'rectangle') {
                ctx.strokeRect(click.startX, click.startY, width, height);
                if (click.fill === 'solid') {
                    ctx.globalAlpha = 0.3;
                    ctx.fillRect(click.startX, click.startY, width, height);
                    ctx.globalAlpha = 1;
                }
            } else if (click.shape === 'circle') {
                const centerX = click.startX + width / 2;
                const centerY = click.startY + height / 2;
                const radius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                
                if (click.fill === 'solid') {
                    ctx.globalAlpha = 0.3;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            } else if (click.shape === 'arrow') {
                drawArrow(click.startX, click.startY, click.endX, click.endY, click.color, click.lineWidth);
            }
        }

        function drawArrow(startX, startY, endX, endY, color, lineWidth) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = lineWidth || 2;
            
            // Draw main line
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.stroke();
            
            // Calculate arrow head
            const angle = Math.atan2(endY - startY, endX - startX);
            const headLength = 15;
            
            // Draw arrow head
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - headLength * Math.cos(angle - Math.PI / 6),
                endY - headLength * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - headLength * Math.cos(angle + Math.PI / 6),
                endY - headLength * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        function drawText(click) {
            const fontSize = parseInt(click.size);
            ctx.fillStyle = click.color;
            ctx.font = `${fontSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            const lines = click.text.split('\n');
            lines.forEach((line, index) => {
                ctx.fillText(line, click.x, click.y + index * fontSize * 1.2);
            });
        }

        function drawEmoji(click) {
            const fontSize = parseInt(click.size);
            ctx.font = `${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(click.emoji, click.x, click.y);
        }

        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê³„ì‚° í•¨ìˆ˜
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        canvas.addEventListener('mousedown', (e) => {
            if (currentMode === 'number') {
                handleNumberClick(e);
            } else if (currentMode === 'shape') {
                handleShapeStart(e);
            } else if (currentMode === 'text') {
                handleTextClick(e);
            } else if (currentMode === 'emoji') {
                handleEmojiClick(e);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing && currentMode === 'shape') {
                handleShapeMove(e);
            }
            updateStatusText(e);
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDrawing && currentMode === 'shape') {
                handleShapeEnd(e);
            }
        });

        function handleNumberClick(e) {
            const pos = getMousePos(e);
            clickCount++;
            const numberClick = {
                type: 'number',
                x: pos.x,
                y: pos.y,
                color: currentColor,
                size: currentSize,
                number: clickCount
            };
            clicks.push(numberClick);
            redrawCanvas();
        }

        function handleShapeStart(e) {
            const pos = getMousePos(e);
            startX = pos.x;
            startY = pos.y;
            isDrawing = true;
        }

        function handleShapeMove(e) {
            if (!isDrawing) return;
            
            redrawCanvas(); // Redraw everything
            
            // Draw preview of current shape
            const pos = getMousePos(e);
            ctx.save();
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentLineWidth;
            ctx.setLineDash([5, 5]); // Dashed line for preview
            
            const width = pos.x - startX;
            const height = pos.y - startY;
            
            if (currentShape === 'rectangle') {
                ctx.strokeRect(startX, startY, width, height);
            } else if (currentShape === 'circle') {
                const centerX = startX + width / 2;
                const centerY = startY + height / 2;
                const radius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
            } else if (currentShape === 'arrow') {
                drawArrow(startX, startY, pos.x, pos.y, currentColor, currentLineWidth);
            }
            
            ctx.restore();
        }

        function handleShapeEnd(e) {
            if (!isDrawing) return;
            
            const pos = getMousePos(e);
            const shapeClick = {
                type: 'shape',
                startX: startX,
                startY: startY,
                endX: pos.x,
                endY: pos.y,
                color: currentColor,
                lineWidth: currentLineWidth,
                shape: currentShape,
                fill: currentFill
            };
            
            clicks.push(shapeClick);
            isDrawing = false;
            redrawCanvas();
        }

        function handleTextClick(e) {
            const pos = getMousePos(e);
            const text = prompt('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (text && text.trim()) {
                const textClick = {
                    type: 'text',
                    x: pos.x,
                    y: pos.y,
                    text: text.trim(),
                    color: currentColor,
                    size: currentSize
                };
                clicks.push(textClick);
                redrawCanvas();
            }
        }

        function handleEmojiClick(e) {
            const pos = getMousePos(e);
            const emojiClick = {
                type: 'emoji',
                x: pos.x,
                y: pos.y,
                emoji: emojiSelector.value,
                size: currentSize
            };
            clicks.push(emojiClick);
            redrawCanvas();
        }

        function updateStatusText(e) {
            const pos = getMousePos(e);
            document.getElementById('statusText').textContent = 
                `ë§ˆìš°ìŠ¤ ìœ„ì¹˜: ${Math.round(pos.x)}, ${Math.round(pos.y)}`;
        }

        // ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        modeSelector.addEventListener('change', (e) => {
            currentMode = e.target.value;
            updateControlsVisibility();
        });

        colorSelector.addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        sizeSelector.addEventListener('change', (e) => {
            currentSize = e.target.value;
        });

        shapeSelector.addEventListener('change', (e) => {
            currentShape = e.target.value;
            updateFillVisibility();
        });

        fillSelector.addEventListener('change', (e) => {
            currentFill = e.target.value;
        });

        lineWidthSelector.addEventListener('change', (e) => {
            currentLineWidth = parseInt(e.target.value);
        });

        function updateControlsVisibility() {
            // Hide all mode-specific controls
            document.getElementById('shapeSection').style.display = 'none';
            document.getElementById('fillSection').style.display = 'none';
            document.getElementById('lineWidthSection').style.display = 'none';
            document.getElementById('emojiSection').style.display = 'none';
            document.getElementById('cropSection').style.display = 'none';
            document.getElementById('cropControlsSection').style.display = 'none';
            
            // Show controls based on current mode
            if (currentMode === 'shape') {
                document.getElementById('shapeSection').style.display = 'block';
                document.getElementById('lineWidthSection').style.display = 'block';
                updateFillVisibility();
            } else if (currentMode === 'emoji') {
                document.getElementById('emojiSection').style.display = 'block';
            } else if (currentMode === 'crop') {
                document.getElementById('cropSection').style.display = 'block';
                document.getElementById('cropControlsSection').style.display = 'block';
            }
        }

        function updateFillVisibility() {
            if (currentShape === 'arrow') {
                document.getElementById('fillSection').style.display = 'none';
            } else {
                document.getElementById('fillSection').style.display = 'block';
            }
        }

        // íŒŒì¼ ê´€ë ¨ ê¸°ëŠ¥ë“¤
        imageLoader.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    loadImageFromDataUrl(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        clipboardButton.addEventListener('click', async () => {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                loadImageFromDataUrl(event.target.result);
                            };
                            reader.readAsDataURL(blob);
                            break;
                        }
                    }
                }
            } catch (error) {
                showMessage('í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });

        saveButton.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'annotateshot.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        copyToClipboardButton.addEventListener('click', async () => {
            try {
                canvas.toBlob(async (blob) => {
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    showMessage('ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
            } catch (error) {
                showMessage('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        undoButton.addEventListener('click', () => {
            if (clicks.length > 0) {
                clicks.pop();
                redrawCanvas();
            }
        });

        resizeSelector.addEventListener('change', () => {
            if (currentImage) {
                applyImageToCanvas();
            }
        });

        // ìº”ë²„ìŠ¤ ëª¨ë“œ ê´€ë ¨ ì´ë²¤íŠ¸
        canvasModeSelector.addEventListener('change', (e) => {
            switchCanvasMode(e.target.value);
        });

        backgroundColorSelector.addEventListener('change', (e) => {
            setCanvasBackgroundColor(e.target.value);
        });

        canvasSizeSelector.addEventListener('change', (e) => {
            setCanvasSize(e.target.value);
            if (e.target.value === 'custom') {
                document.getElementById('customSizeSection').style.display = 'block';
            } else {
                document.getElementById('customSizeSection').style.display = 'none';
            }
        });

        applyCustomSize.addEventListener('click', () => {
            setCanvasSize('custom');
        });

        function switchCanvasMode(newMode) {
            const previousMode = canvasMode;
            canvasMode = newMode;
            
            if (newMode === 'multi') {
                // Show multi-mode specific controls
                document.getElementById('backgroundColorSection').style.display = 'block';
                document.getElementById('canvasSizeSection').style.display = 'block';
                
                // Clear single mode data
                currentImage = null;
                
                // Show blank canvas or existing multi-mode content
                if (imageLayers.length === 0) {
                    drawBlankMultiCanvas();
                } else {
                    redrawCanvas();
                }
            } else {
                // Hide multi-mode specific controls
                document.getElementById('backgroundColorSection').style.display = 'none';
                document.getElementById('canvasSizeSection').style.display = 'none';
                document.getElementById('customSizeSection').style.display = 'none';
                
                // Clear multi mode data
                imageLayers = [];
                window.imageLayers = imageLayers;
                
                // Show default single mode canvas
                drawSingleModeDefaultCanvas();
            }
            
            // Clear annotations when switching modes
            clicks = [];
            clickCount = 0;
            layers = layers.filter(layer => layer.type === 'background');
        }

        function setCanvasBackgroundColor(color) {
            canvasBackgroundColor = color;
            if (canvasMode === 'multi') {
                drawBlankMultiCanvas();
            }
        }

        function setCanvasSize(size) {
            canvasSize = size;
            if (canvasMode === 'multi') {
                if (imageLayers.length === 0) {
                    drawBlankMultiCanvas();
                } else {
                    const { width, height } = getCanvasSize();
                    applyCanvasDimensions(width, height);
                    redrawCanvas();
                }
            }
        }

        function addImageAsNewLayer() {
            // ìƒˆ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ë¦¬ì‚¬ì´ì¦ˆ
            const canvasWidth = parseInt(canvas.style.width);
            const canvasHeight = parseInt(canvas.style.height);
            
            // ì´ë¯¸ì§€ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ìº”ë²„ìŠ¤ì— ë§ëŠ” í¬ê¸° ê³„ì‚°
            const imageAspectRatio = currentImage.width / currentImage.height;
            const canvasAspectRatio = canvasWidth / canvasHeight;
            
            let newWidth, newHeight, x, y;
            
            if (imageAspectRatio > canvasAspectRatio) {
                newWidth = Math.min(canvasWidth * 0.8, currentImage.width);
                newHeight = newWidth / imageAspectRatio;
            } else {
                newHeight = Math.min(canvasHeight * 0.8, currentImage.height);
                newWidth = newHeight * imageAspectRatio;
            }
            
            // ì¤‘ì•™ì— ë°°ì¹˜
            x = (canvasWidth - newWidth) / 2;
            y = (canvasHeight - newHeight) / 2;
            
            // ìƒˆ ì´ë¯¸ì§€ ë ˆì´ì–´ ìƒì„±
            const newImageLayer = createImageLayer(
                currentImage,
                x, y,
                newWidth, newHeight
            );
            imageLayers.push(newImageLayer);
            
            // ì „ì—­ ì—…ë°ì´íŠ¸
            window.imageLayers = imageLayers;
            
            // ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            redrawCanvas();
            
            showMessage(translate('imageLayerAdded', { 
                layerNumber: imageLayers.length,
                width: Math.round(newWidth), 
                height: Math.round(newHeight) 
            }));
        }

        // Clear all annotations function
        function clearAllAnnotations() {
            clicks = [];
            clickCount = 0;
            layers = layers.filter(layer => layer.type === 'background');
            redrawCanvas();
        }

        // ë ˆì´ì–´ ê´€ë ¨ í•¨ìˆ˜ë“¤
        document.getElementById('clearAllLayers').addEventListener('click', () => {
            if (confirm('ëª¨ë“  ì£¼ì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                clearAllAnnotations();
            }
        });

        // Theme toggle functionality
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const themeIcon = themeToggle.querySelector('.material-icons');
            
            // Check for saved theme or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('dark');
                themeIcon.textContent = 'light_mode';
            } else {
                themeIcon.textContent = 'dark_mode';
            }
            
            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark');
                const isDark = body.classList.contains('dark');
                themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        function showAbout() {
            alert('AnnotateShot - ìŠ¤í¬ë¦°ìƒ·ì— ì‰½ê²Œ ìˆ«ìì™€ ë„í˜•ì„ ì¶”ê°€í•˜ì„¸ìš”.\n\në²„ì „: ìŠ¤íƒ ë“œì–¼ë¡ \nê°œë°œì: AnnotateShot Team');
        }

        // Global function exports
        window.layers = layers;
        window.clicks = clicks;
        window.imageLayers = imageLayers;
        window.redrawCanvas = redrawCanvas;
        window.clearAllAnnotations = clearAllAnnotations;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateControlsVisibility();
            drawSingleModeDefaultCanvas();
            
            // ì´ˆê¸° ì–¸ì–´ ì„¤ì •
            currentLanguage = getLanguage();
            const langSelect = document.getElementById('languageSelector');
            if (langSelect) {
                langSelect.value = currentLanguage;
            }
            applyLanguage();
        });
    </script>
</body>
</html>