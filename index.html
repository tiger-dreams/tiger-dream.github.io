<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-3945001668113003">
    <title>Interactive Image Clicker</title>
    <style>
        #imageContainer {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }
        #controls {
            margin-bottom: 10px;
        }
        button {
            margin-right: 10px;
        }
        #message {
            margin-top: 10px;
            color: green;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3945001668113003"
     crossorigin="anonymous"></script>
</head>
<body>
    <div id="controls">
        <input type="file" id="imageLoader" accept="image/*">
        <button id="clipboardButton">클립보드에서 가져오기</button>
        <button id="saveButton">저장하기</button>
    </div>
    <div id="imageContainer">
        <canvas id="imageCanvas"></canvas>
    </div>
    <div id="message"></div>

    <script>
        const MAX_WIDTH = 1400;
        const imageLoader = document.getElementById('imageLoader');
        const clipboardButton = document.getElementById('clipboardButton');
        const saveButton = document.getElementById('saveButton');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const messageDiv = document.getElementById('message');
        let clickCount = 0;
        let clicks = [];
        let currentImage = null;

        imageLoader.addEventListener('change', handleFileSelect, false);
        clipboardButton.addEventListener('click', handleClipboardPaste, false);
        saveButton.addEventListener('click', saveImage, false);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                loadImageFromFile(file);
            }
        }

        function handleClipboardPaste() {
            navigator.clipboard.read().then(items => {
                for (let item of items) {
                    if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                        item.getType('image/png').then(blob => {
                            loadImageFromBlob(blob);
                        }).catch(() => {
                            item.getType('image/jpeg').then(blob => {
                                loadImageFromBlob(blob);
                            });
                        });
                        return;
                    }
                }
                messageDiv.textContent = "클립보드에서 이미지를 찾을 수 없습니다.";
            }).catch(err => {
                console.error("클립보드 접근 오류:", err);
                messageDiv.textContent = "클립보드 접근에 실패했습니다. 브라우저 설정을 확인해주세요.";
            });
        }

        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImageFromDataUrl(event.target.result);
            }
            reader.readAsDataURL(file);
        }

        function loadImageFromBlob(blob) {
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImageFromDataUrl(event.target.result);
            }
            reader.readAsDataURL(blob);
        }

        function loadImageFromDataUrl(dataUrl) {
            currentImage = new Image();
            currentImage.onload = function() {
                let width = currentImage.width;
                let height = currentImage.height;

                if (width > MAX_WIDTH) {
                    const scaleFactor = MAX_WIDTH / width;
                    width = MAX_WIDTH;
                    height = Math.floor(height * scaleFactor);
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(currentImage, 0, 0, width, height);
                messageDiv.textContent = `이미지가 로드되었습니다. 크기: ${width}x${height}`;
                clicks = [];
                clickCount = 0;
            }
            currentImage.src = dataUrl;
        }

        function saveImage() {
            if (!currentImage) {
                messageDiv.textContent = "저장할 이미지가 없습니다. 먼저 이미지를 로드해주세요.";
                return;
            }

            try {
                let fileName = prompt("저장할 파일명을 입력하세요 (확장자 제외):", "interactive_image");
                
                if (fileName === null || fileName.trim() === "") {
                    fileName = "interactive_image";
                }

                fileName += ".png";

                const dataURL = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = fileName;
                link.href = dataURL;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                messageDiv.textContent = `이미지가 "${fileName}" 이름으로 성공적으로 저장되었습니다. 다운로드 폴더를 확인해주세요.`;
            } catch (err) {
                console.error("저장 중 오류 발생:", err);
                messageDiv.textContent = "이미지 저장 중 오류가 발생했습니다. 콘솔을 확인해주세요.";
            }
        }

        canvas.addEventListener('click', function(e) {
            if (!currentImage) {
                messageDiv.textContent = "클릭하기 전에 먼저 이미지를 로드해주세요.";
                return;
            }

            clickCount++;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            clicks.push({x, y, count: clickCount});
            redrawCanvas();
            messageDiv.textContent = `클릭 ${clickCount}: (${Math.round(x)}, ${Math.round(y)})`;
        });

        function redrawCanvas() {
            if (!currentImage) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

            clicks.forEach(click => {
                ctx.beginPath();
                ctx.arc(click.x, click.y, 15, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(click.count, click.x, click.y);
            });
        }
    </script>
</body>
</html>
