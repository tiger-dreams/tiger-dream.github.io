<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-3945001668113003">
    <title>Interactive Image Clicker</title>
    <style>
        #imageContainer {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }
        #controls {
            margin-bottom: 10px;
        }
        button, select {
            margin-right: 10px;
        }
        #message {
            margin-top: 10px;
            color: green;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3945001668113003"
     crossorigin="anonymous"></script>
</head>
<body>
    <div id="controls">
        <input type="file" id="imageLoader" accept="image/*">
        <button id="clipboardButton">클립보드에서 가져오기</button>
        <button id="saveButton">저장하기</button>
        <button id="undoButton">뒤로가기</button>
        <select id="colorSelector">
            <option value="#FF0000">빨간색</option>
            <option value="#FF8000">주황색</option>
            <option value="#00FF00">녹색</option>
            <option value="#0000FF">파랑색</option>
        </select>
        <select id="sizeSelector">
            <option value="small">작게</option>
            <option value="medium" selected>보통</option>
            <option value="large">크게</option>
        </select>
    </div>
    <div id="imageContainer">
        <canvas id="imageCanvas"></canvas>
    </div>
    <div id="message"></div>
    <div id="shortcuts">
        <p>단축키: Ctrl+Z (Mac: Command+Z) - 마지막 클릭 취소</p>
    </div>

    <script>
        const MAX_WIDTH = 1400;
        const imageLoader = document.getElementById('imageLoader');
        const clipboardButton = document.getElementById('clipboardButton');
        const saveButton = document.getElementById('saveButton');
        const undoButton = document.getElementById('undoButton');
        const colorSelector = document.getElementById('colorSelector');
        const sizeSelector = document.getElementById('sizeSelector');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const messageDiv = document.getElementById('message');
        let clickCount = 0;
        let clicks = [];
        let currentImage = null;
        let currentColor = "#FF0000"; // 기본 색상
        let currentSize = "medium"; // 기본 크기

        function loadImageFromUrl(url) {
            console.log("Attempting to load image from:", url);
            currentImage = new Image();
            currentImage.crossOrigin = "anonymous";
            currentImage.onload = function() {
                console.log("Image loaded successfully");
                let width = currentImage.width;
                let height = currentImage.height;
        
                if (width > MAX_WIDTH) {
                    const scaleFactor = MAX_WIDTH / width;
                    width = MAX_WIDTH;
                    height = Math.floor(height * scaleFactor);
                }
        
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(currentImage, 0, 0, width, height);
                messageDiv.textContent = `기본 이미지가 로드되었습니다. 크기: ${width}x${height}`;
                clicks = [];
                clickCount = 0;
            }
            currentImage.onerror = function(err) {
                console.error("Image load failed:", url, err);
                messageDiv.textContent = "기본 이미지 로드에 실패했습니다.";
            }
            currentImage.src = url;
        }
        
        // 기본 이미지 로드
        window.onload = function() {
            loadImageFromUrl('https://raw.githubusercontent.com/tiger-dreams/tiger-dream.github.io/main/src/default-image.jpg');
        }
        
        imageLoader.addEventListener('change', handleFileSelect, false);
        clipboardButton.addEventListener('click', handleClipboardPaste, false);
        saveButton.addEventListener('click', saveImage, false);
        undoButton.addEventListener('click', undoLastClick, false);
        colorSelector.addEventListener('change', function(e) {
            currentColor = e.target.value;
            redrawCanvas();
        });
        sizeSelector.addEventListener('change', function(e) {
            currentSize = e.target.value;
            redrawCanvas();
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                loadImageFromFile(file);
            }
        }

        function handleClipboardPaste() {
            navigator.clipboard.read().then(items => {
                for (let item of items) {
                    if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                        item.getType('image/png').then(blob => {
                            loadImageFromBlob(blob);
                        }).catch(() => {
                            item.getType('image/jpeg').then(blob => {
                                loadImageFromBlob(blob);
                            });
                        });
                        return;
                    }
                }
                messageDiv.textContent = "클립보드에서 이미지를 찾을 수 없습니다.";
            }).catch(err => {
                console.error("클립보드 접근 오류:", err);
                messageDiv.textContent = "클립보드 접근에 실패했습니다. 브라우저 설정을 확인해주세요.";
            });
        }

        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImageFromDataUrl(event.target.result);
            }
            reader.readAsDataURL(file);
        }

        function loadImageFromBlob(blob) {
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImageFromDataUrl(event.target.result);
            }
            reader.readAsDataURL(blob);
        }

        function loadImageFromDataUrl(dataUrl) {
            currentImage = new Image();
            currentImage.onload = function() {
                let width = currentImage.width;
                let height = currentImage.height;

                if (width > MAX_WIDTH) {
                    const scaleFactor = MAX_WIDTH / width;
                    width = MAX_WIDTH;
                    height = Math.floor(height * scaleFactor);
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(currentImage, 0, 0, width, height);
                messageDiv.textContent = `이미지가 로드되었습니다. 크기: ${width}x${height}`;
                clicks = [];
                clickCount = 0;
            }
            currentImage.src = dataUrl;
        }

        function saveImage() {
            if (!currentImage) {
                messageDiv.textContent = "저장할 이미지가 없습니다. 먼저 이미지를 로드해주세요.";
                return;
            }

            try {
                let fileName = prompt("저장할 파일명을 입력하세요 (확장자 제외):", "interactive_image");
                
                if (fileName === null || fileName.trim() === "") {
                    fileName = "interactive_image";
                }

                fileName += ".png";

                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = fileName;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    messageDiv.textContent = `이미지가 "${fileName}" 이름으로 성공적으로 저장되었습니다. 다운로드 폴더를 확인해주세요.`;
                }, 'image/png');
            } catch (err) {
                console.error("저장 중 오류 발생:", err);
                messageDiv.textContent = "이미지 저장 중 오류가 발생했습니다. 콘솔을 확인해주세요.";
            }
        }

        canvas.addEventListener('click', function(e) {
            if (!currentImage) {
                messageDiv.textContent = "클릭하기 전에 먼저 이미지를 로드해주세요.";
                return;
            }

            clickCount++;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            clicks.push({x, y, count: clickCount, color: currentColor, size: currentSize});
            redrawCanvas();
            messageDiv.textContent = `클릭 ${clickCount}: (${Math.round(x)}, ${Math.round(y)})`;
        });

        function redrawCanvas() {
            if (!currentImage) return;

            // 캔버스 크기 재설정
            canvas.width = canvas.width;

            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

            clicks.forEach((click, index) => {
                ctx.beginPath();
                let circleSize = 15; // 기본 원 크기
                let fontSize = 16; // 기본 폰트 크기

                switch(click.size) {
                    case 'small':
                        circleSize = 10;
                        fontSize = 12;
                        break;
                    case 'large':
                        circleSize = 20;
                        fontSize = 20;
                        break;
                }

                ctx.arc(click.x, click.y, circleSize, 0, 2 * Math.PI);
                ctx.fillStyle = click.color;
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(index + 1, click.x, click.y);
            });
        }

        function undoLastClick() {
            if (clicks.length > 0) {
                clicks.pop();
                clickCount--;
                redrawCanvas();
                if (clicks.length > 0) {
                    const lastClick = clicks[clicks.length - 1];
                    messageDiv.textContent = `마지막 클릭 취소됨. 현재 클릭 수: ${clickCount}`;
                } else {
                    messageDiv.textContent = '모든 클릭이 취소되었습니다.';
                }
            } else {
                messageDiv.textContent = '취소할 클릭이 없습니다.';
            }
        }

        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
                event.preventDefault();
                undoLastClick();
            }
        });
    </script>
        <!-- 페이지뷰 카운터 추가 -->
    <div style="text-align: center; margin-top: 20px;">
        <a href="https://hits.seeyoufarm.com">
            <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Falllogo.net&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=true"/>
        </a>
    </div>
</body>
</html>
